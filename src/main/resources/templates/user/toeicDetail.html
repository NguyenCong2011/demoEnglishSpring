<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết đề thi TOEIC</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .info { margin-bottom: 20px; }
        .buttons { display: flex; gap: 20px; }
        .buttons button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        .btn-start { background-color: #28a745; color: white; border: none; }
        .btn-friends { background-color: #007bff; color: white; border: none; }

        /* Pop-up styles */
        .popup {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Background overlay */
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .popup-buttons {
            margin-top: 20px;
        }

        .popup-buttons button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }

        .btn-accept {
            background-color: #28a745;
            color: white;
            border: none;
        }

        .btn-reject {
            background-color: #dc3545;
            color: white;
            border: none;
        }
    </style>
</head>
<body>

<div th:replace="~{header.html}"></div>

<h2 th:text="${toeicExam.examName}">Tên đề thi</h2>

<div class="info">
    <p><strong>Thời gian:</strong> <span th:text="${toeicExam.duration}"></span> phút</p>
    <p><strong>Mô tả:</strong> <span th:text="${toeicExam.description}"></span></p>
</div>

<h3>Phân bổ câu hỏi:</h3>
<ul>
    <li>Part 1 (Listening): 6 câu</li>
    <li>Part 2 (Listening): 25 câu</li>
    <li>Part 3 (Listening): 40 câu</li>
    <li>Part 4 (Listening): 19 câu</li>
    <li>Part 5 (Reading): 19 câu</li>
    <li>Part 6 (Reading): 16 câu</li>
    <li>Part 7 (Reading): 55 câu</li>
</ul>

<div class="buttons">
    <form th:action="@{/user/show-toeic-question/{examId}(examId=${examId})}" method="get">
        <button type="submit" class="btn-start">Bắt đầu thi</button>
    </form>
</div>

<!-- Thi cùng bạn bè -->
<div style="margin-top: 30px;">
    <h3>Thi cùng bạn bè</h3>
    <input type="text" id="searchUserInput" placeholder="Nhập tên người dùng..." />
    <button onclick="searchUser()">Tìm kiếm</button>

    <div id="searchUserResult"></div>
</div>

<!-- Pop-up khi nhận lời mời -->
<div id="invitePopup" class="popup">
    <div class="popup-content">
        <h3 id="inviteMessage"></h3>
        <div class="popup-buttons">
            <button id="acceptBtn" class="btn-accept">Chấp nhận</button>
            <button id="rejectBtn" class="btn-reject">Từ chối</button>
        </div>
    </div>
</div>

<!-- Lịch sử thi đấu -->
<div style="margin-top: 40px;">
    <h3>Lịch sử thi đấu của đề này</h3>

    <table border="1" cellpadding="10" style="border-collapse: collapse; width: 100%;">
        <thead>
        <tr>
            <th>Phòng</th>
            <th>Người chơi 1</th>
            <th>Điểm</th>
            <th>Người chơi 2</th>
            <th>Điểm</th>
            <th>Kết quả</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="match : ${competitionHistory}">
            <td th:text="${match.roomId}">Room</td>
            <td th:text="${match.user1.username}">User 1</td>
            <td th:text="${match.user1Score}">-</td>
            <td th:text="${match.user2 != null ? match.user2.username : 'Đang chờ...'}">User 2</td>
            <td th:text="${match.user2Score != null ? match.user2Score : '-'}">-</td>
            <td>
                <span th:if="${match.user2Score == null}">Đang chờ</span>

                <span th:if="${match.user1.id == currentUserId}">
            <span th:if="${match.user1Score > match.user2Score}">Thắng</span>
            <span th:if="${match.user1Score == match.user2Score}">Hòa</span>
            <span th:if="${match.user1Score < match.user2Score}">Thua</span>
        </span>

                <span th:if="${match.user2 != null and match.user2.id == currentUserId}">
            <span th:if="${match.user2Score > match.user1Score}">Thắng</span>
            <span th:if="${match.user2Score == match.user1Score}">Hòa</span>
            <span th:if="${match.user2Score < match.user1Score}">Thua</span>
        </span>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- SockJS + STOMP -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    let stompClient = null;
    let currentInviteData = null;  // Lưu trữ thông tin lời mời để xử lý sau

    // Dữ liệu Thymeleaf render từ server
    const currentUserId = '[[${currentUserId}]]';
    const currentUsername = '[[${currentUsername}]]';
    const examId = '[[${examId}]]';
    const examName = '[[${toeicExam.examName}]]';

    // Kết nối WebSocket
    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function () {
            console.log("WebSocket connected");

            // Nhận lời mời
            stompClient.subscribe(`/topic/invite/${currentUserId}`, function (message) {
                const data = JSON.parse(message.body);
                showInvitePopup(data);  // Hiển thị pop-up khi có lời mời
            });

            // ✅ Nhận tín hiệu chấp nhận và redirect tới bài thi
            stompClient.subscribe(`/topic/accept/${currentUserId}`, function (message) {
                const invite = JSON.parse(message.body);
                const examId = invite.examId;

                if (examId) {
                    window.location.href = "/user/show-toeic-question/" + examId;
                } else {
                    alert("Không tìm thấy đề thi để làm!");
                }
            });
        });
    }


    // Hiển thị pop-up khi nhận lời mời
    function showInvitePopup(data) {
        currentInviteData = data;  // Lưu lại thông tin lời mời
        const inviteMessage = `${data.senderUsername} mời bạn thi bài thi ${data.examName}`;
        document.getElementById("inviteMessage").innerText = inviteMessage;
        document.getElementById("invitePopup").style.display = "flex";  // Hiển thị pop-up
    }

    // Xử lý chấp nhận lời mời
    document.getElementById("acceptBtn").addEventListener("click", function() {
        acceptInvite(currentInviteData);
    });

    // Xử lý từ chối lời mời
    document.getElementById("rejectBtn").addEventListener("click", function() {
        rejectInvite(currentInviteData);
    });

    // Gửi phản hồi chấp nhận lời mời
    function acceptInvite(data) {
        // Gửi thông báo chấp nhận qua WebSocket
        stompClient.send("/app/accept-invite", {}, JSON.stringify(data));

        // Thông báo cho người dùng
        alert(`Bạn đã chấp nhận lời mời từ ${data.senderUsername}`);
        closePopup();  // Đóng pop-up
    }

    // Gửi phản hồi từ chối lời mời
    function rejectInvite(data) {
        // Gửi thông báo từ chối qua WebSocket
        stompClient.send("/app/reject-invite", {}, JSON.stringify(data));

        // Thông báo cho người dùng
        alert(`Bạn đã từ chối lời mời từ ${data.senderUsername}`);
        closePopup();  // Đóng pop-up
    }

    // Đóng pop-up
    function closePopup() {
        document.getElementById("invitePopup").style.display = "none";
    }

    // Gửi lời mời
    function inviteUser(receiverId) {
        const invite = {
            senderId: currentUserId,
            senderUsername: currentUsername,
            receiverId: receiverId,
            examId: examId,
            examName: examName
        };

        stompClient.send("/app/invite", {}, JSON.stringify(invite));
        alert("Đã gửi lời mời!");
    }

    // Tìm người dùng
    function searchUser() {
        const keyword = document.getElementById("searchUserInput").value.trim();
        const resultDiv = document.getElementById("searchUserResult");

        if (!keyword) {
            resultDiv.innerHTML = "<p>Vui lòng nhập từ khóa tìm kiếm.</p>";
            return;
        }

        fetch(`/user/search-users?keyword=${encodeURIComponent(keyword)}`)
            .then(response => response.json())
            .then(data => {
                if (data.result.length === 0) {
                    resultDiv.innerHTML = `<p style="color:red;">Không tìm thấy người dùng nào.</p>`;
                    return;
                }

                let html = "<ul>";
                data.result.forEach(user => {
                    html += `<li>${user.username} <button onclick="inviteUser('${user.id}')">Invite</button></li>`;
                });
                html += "</ul>";
                resultDiv.innerHTML = html;
            })
            .catch(error => {
                resultDiv.innerHTML = `<p style="color:red;">Có lỗi xảy ra khi tìm kiếm người dùng.</p>`;
            });
    }

    connectWebSocket();
</script>

<div th:replace="~{footer.html}"></div>

</body>
</html>
