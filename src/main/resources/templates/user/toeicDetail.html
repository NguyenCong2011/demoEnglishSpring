<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết đề thi TOEIC</title>
</head>
<body>

<div th:replace="~{header.html}"></div>

<div class="container mx-auto px-4 py-6">
    <!-- Tiêu đề và mô tả bài thi -->
    <h2 class="text-4xl font-semibold text-center text-gray-900 mb-8 transition-transform transform hover:scale-110 hover:text-blue-500 hover:tracking-wide">
        <span th:text="${toeicExam.examName}">Tên đề thi</span>
    </h2>

    <div class="bg-gradient-to-r from-indigo-500 to-blue-400 p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 hover:bg-gradient-to-r hover:from-indigo-600 hover:to-blue-500 mb-10">
        <p class="text-xl text-gray-100"><strong class="font-semibold">Thời gian:</strong> <span th:text="${toeicExam.duration}"></span> phút</p>
        <p class="text-xl text-gray-100"><strong class="font-semibold">Mô tả:</strong> <span th:text="${toeicExam.description}"></span></p>
    </div>


    <!-- Phân bổ câu hỏi -->
    <h3 class="text-3xl font-semibold text-gray-800 mb-6 transition-all duration-300 ease-in-out transform hover:text-blue-600 hover:scale-105 hover:shadow-lg hover:shadow-blue-500/50">
        Phân bổ câu hỏi:
    </h3>

    <ul class="list-disc pl-8 space-y-4 text-lg">
        <li class="transition duration-300 ease-in-out transform hover:scale-105 hover:text-blue-500">
            <span class="font-medium">Part 1 (Listening):</span> 6 câu
        </li>
        <li class="transition duration-300 ease-in-out transform hover:scale-105 hover:text-blue-500">
            <span class="font-medium">Part 2 (Listening):</span> 25 câu
        </li>
        <li class="transition duration-300 ease-in-out transform hover:scale-105 hover:text-blue-500">
            <span class="font-medium">Part 3 (Listening):</span> 40 câu
        </li>
        <li class="transition duration-300 ease-in-out transform hover:scale-105 hover:text-blue-500">
            <span class="font-medium">Part 4 (Listening):</span> 19 câu
        </li>
        <li class="transition duration-300 ease-in-out transform hover:scale-105 hover:text-blue-500">
            <span class="font-medium">Part 5 (Reading):</span> 19 câu
        </li>
        <li class="transition duration-300 ease-in-out transform hover:scale-105 hover:text-blue-500">
            <span class="font-medium">Part 6 (Reading):</span> 16 câu
        </li>
        <li class="transition duration-300 ease-in-out transform hover:scale-105 hover:text-blue-500">
            <span class="font-medium">Part 7 (Reading):</span> 55 câu
        </li>
    </ul>


    <!-- Nút bắt đầu thi -->
    <div class="mt-6 flex justify-center">
        <form th:action="@{/user/show-toeic-question/{examId}(examId=${examId})}" method="get">
            <button type="submit" class="bg-blue-600 text-white py-3 px-8 rounded-lg hover:bg-blue-700 hover:scale-105 transition-all duration-300 transform shadow-lg">
                Bắt đầu thi
            </button>
        </form>
    </div>

    <!-- Thi cùng bạn bè -->
    <div class="mt-12">
        <h3 class="text-2xl font-semibold text-gray-700 mb-4">Thi cùng bạn bè</h3>
        <div class="flex items-center space-x-4">
            <input type="text" id="searchUserInput" class="border border-gray-300 rounded-lg px-4 py-2 w-1/2 text-lg focus:ring-2 focus:ring-blue-600 transition-all" placeholder="Nhập tên người dùng..." />
            <button onclick="searchUser()" class="bg-green-500 text-white py-2 px-6 rounded-lg hover:bg-green-600 focus:ring-2 focus:ring-green-600 transition duration-300 transform hover:scale-105">
                Tìm kiếm
            </button>
        </div>
        <div id="searchUserResult" class="mt-4"></div>
    </div>

    <!-- Pop-up khi nhận lời mời -->
    <div id="invitePopup" class="popup fixed inset-0 bg-gray-500 bg-opacity-50 flex items-center justify-center hidden">
        <div class="popup-content bg-white p-8 rounded-lg shadow-2xl w-96 transition-transform transform hover:scale-105">
            <h3 id="inviteMessage" class="text-xl font-semibold mb-4"></h3>
            <div class="flex justify-between">
                <button id="acceptBtn" class="bg-green-500 text-white py-2 px-6 rounded-lg hover:bg-green-600 transition duration-300 transform hover:scale-105">
                    Chấp nhận
                </button>
                <button id="rejectBtn" class="bg-red-500 text-white py-2 px-6 rounded-lg hover:bg-red-600 transition duration-300 transform hover:scale-105">
                    Từ chối
                </button>
            </div>
        </div>
    </div>

    <!-- Lịch sử thi đấu -->
    <div class="mt-12">
        <h3 class="text-2xl font-semibold text-gray-700 mb-4">Lịch sử thi đấu của đề này</h3>
        <table class="table-auto w-full border-collapse bg-white shadow-md rounded-lg overflow-hidden">
            <thead>
            <tr class="bg-gray-100 hover:bg-gray-200 transition-colors">
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Phòng</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Người chơi 1</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Điểm</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Người chơi 2</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Điểm</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-700">Kết quả</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="match : ${competitionHistory}" class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 text-sm font-medium text-gray-900" th:text="${match.roomId}">Room</td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900" th:text="${match.user1.username}">User 1</td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900" th:text="${match.user1Score}">-</td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900" th:text="${match.user2 != null ? match.user2.username : 'Đang chờ...'}">User 2</td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900" th:text="${match.user2Score != null ? match.user2Score : '-'}">-</td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900">
                    <span th:if="${match.user2Score == null}" class="text-gray-500">Đang chờ</span>
                    <span th:if="${match.user1.id == currentUserId}">
                            <span th:if="${match.user1Score > match.user2Score}" class="text-green-500">Thắng</span>
                            <span th:if="${match.user1Score == match.user2Score}" class="text-yellow-500">Hòa</span>
                            <span th:if="${match.user1Score < match.user2Score}" class="text-red-500">Thua</span>
                        </span>
                    <span th:if="${match.user2 != null and match.user2.id == currentUserId}">
                            <span th:if="${match.user2Score > match.user1Score}" class="text-green-500">Thắng</span>
                            <span th:if="${match.user2Score == match.user1Score}" class="text-yellow-500">Hòa</span>
                            <span th:if="${match.user2Score < match.user1Score}" class="text-red-500">Thua</span>
                        </span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>


<!-- SockJS + STOMP -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    let stompClient = null;
    let currentInviteData = null;  // Lưu trữ thông tin lời mời để xử lý sau

    // Dữ liệu Thymeleaf render từ server
    const currentUserId = '[[${currentUserId}]]';
    const currentUsername = '[[${currentUsername}]]';
    const examId = '[[${examId}]]';
    const examName = '[[${toeicExam.examName}]]';

    // Kết nối WebSocket
    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function () {
            console.log("WebSocket connected");

            // Nhận lời mời
            stompClient.subscribe(`/topic/invite/${currentUserId}`, function (message) {
                const data = JSON.parse(message.body);
                showInvitePopup(data);  // Hiển thị pop-up khi có lời mời
            });

            // ✅ Nhận tín hiệu chấp nhận và redirect tới bài thi
            stompClient.subscribe(`/topic/accept/${currentUserId}`, function (message) {
                const invite = JSON.parse(message.body);
                const examId = invite.examId;

                if (examId) {
                    window.location.href = "/user/show-toeic-question/" + examId;
                } else {
                    alert("Không tìm thấy đề thi để làm!");
                }
            });
        });
    }


    // Hiển thị pop-up khi nhận lời mời
    function showInvitePopup(data) {
        currentInviteData = data;  // Lưu lại thông tin lời mời
        const inviteMessage = `${data.senderUsername} mời bạn thi bài thi ${data.examName}`;
        document.getElementById("inviteMessage").innerText = inviteMessage;
        document.getElementById("invitePopup").style.display = "flex";  // Hiển thị pop-up
    }

    // Xử lý chấp nhận lời mời
    document.getElementById("acceptBtn").addEventListener("click", function() {
        acceptInvite(currentInviteData);
    });

    // Xử lý từ chối lời mời
    document.getElementById("rejectBtn").addEventListener("click", function() {
        rejectInvite(currentInviteData);
    });

    // Gửi phản hồi chấp nhận lời mời
    function acceptInvite(data) {
        // Gửi thông báo chấp nhận qua WebSocket
        stompClient.send("/app/accept-invite", {}, JSON.stringify(data));

        // Thông báo cho người dùng
        alert(`Bạn đã chấp nhận lời mời từ ${data.senderUsername}`);
        closePopup();  // Đóng pop-up
    }

    // Gửi phản hồi từ chối lời mời
    function rejectInvite(data) {
        // Gửi thông báo từ chối qua WebSocket
        stompClient.send("/app/reject-invite", {}, JSON.stringify(data));

        // Thông báo cho người dùng
        alert(`Bạn đã từ chối lời mời từ ${data.senderUsername}`);
        closePopup();  // Đóng pop-up
    }

    // Đóng pop-up
    function closePopup() {
        document.getElementById("invitePopup").style.display = "none";
    }

    // Gửi lời mời
    function inviteUser(receiverId) {
        const invite = {
            senderId: currentUserId,
            senderUsername: currentUsername,
            receiverId: receiverId,
            examId: examId,
            examName: examName
        };

        stompClient.send("/app/invite", {}, JSON.stringify(invite));
        alert("Đã gửi lời mời!");
    }

    // Tìm người dùng
    function searchUser() {
        const keyword = document.getElementById("searchUserInput").value.trim();
        const resultDiv = document.getElementById("searchUserResult");

        if (!keyword) {
            resultDiv.innerHTML = "<p>Vui lòng nhập từ khóa tìm kiếm.</p>";
            return;
        }

        fetch(`/user/search-users?keyword=${encodeURIComponent(keyword)}`)
            .then(response => response.json())
            .then(data => {
                if (data.result.length === 0) {
                    resultDiv.innerHTML = `<p style="color:red;">Không tìm thấy người dùng nào.</p>`;
                    return;
                }

                let html = "<ul>";
                data.result.forEach(user => {
                    html += `<li>${user.username} <button onclick="inviteUser('${user.id}')">Invite</button></li>`;
                });
                html += "</ul>";
                resultDiv.innerHTML = html;
            })
            .catch(error => {
                resultDiv.innerHTML = `<p style="color:red;">Có lỗi xảy ra khi tìm kiếm người dùng.</p>`;
            });
    }

    connectWebSocket();
</script>

<div th:replace="~{footer.html}"></div>

</body>
</html>
